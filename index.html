<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrollable Art Gallery</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the museum feel and smooth scrolling */
        body {
            /* Using a very dark charcoal for the background, feels more 'museum' than pure black */
            background-color: #121212;
            color: #E0E0E0;
            font-family: 'Inter', sans-serif;
            overflow-y: hidden; /* Prevent vertical scroll */
        }
        
        /* The main gallery container for horizontal scrolling */
        .gallery-container {
            width: 100vw;
            height: 100vh;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
        }

        /* Hide scrollbar for a cleaner look, but keep scrolling functionality */
        .gallery-container::-webkit-scrollbar {
            height: 8px;
        }
        .gallery-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }
        .gallery-container::-webkit-scrollbar-track {
            background: #222;
        }

        /* The canvas holding all the grid items */
        .gallery-canvas {
            /* Setting a very wide width to enforce horizontal scrolling for 100 items */
            width: 500vw; 
            min-height: 100vh;
            display: grid;
            /* Defining a large grid template to accommodate the collage effect */
            grid-template-columns: repeat(80, minmax(200px, 1fr)); /* 80 columns total */
            grid-template-rows: repeat(4, 1fr); /* 4 rows high */
            gap: 1.5rem; /* Gap between frames */
            padding: 3rem;
            align-content: start;
        }

        /* Individual Frame Styling and Hover Animation */
        .frame {
            position: relative;
            overflow: hidden;
            border: 2px solid #333; /* Dark grey border */
            border-radius: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            aspect-ratio: 1 / 1; /* Enforce square aspect ratio */
            background-color: #242424; /* Frame fill */
        }

        .frame:hover {
            transform: scale(1.05); /* Slightly bigger on hover */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
            z-index: 10; /* Bring hovered item to front */
        }

        /* Caption Overlay Styling */
        .caption-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none; /* Allows click through to the image */
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .frame:hover .caption-overlay {
            opacity: 1;
        }

        .frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        /* Modal Styles (Adjusted for smaller size) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.3s ease;
        }
        
        .modal-content {
            max-width: 60vw; /* Significantly reduced max width */
            max-height: 70vh; /* Reduced max height */
            background: #1e1e1e;
            padding: 1rem;
            border-radius: 1rem;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            max-height: 60vh;
            overflow: hidden;
            background: #242424;
            border-radius: 0.75rem;
        }

        .modal-image {
            display: block;
            max-width: 100%;
            max-height: 100%; /* Now uses container max-height */
            object-fit: contain; /* Ensures the image fits without cropping */
            border-radius: 0.75rem;
        }

        .modal-controls {
            padding-top: 0.5rem;
        }

        .modal-caption {
            color: #D0D0D0;
            text-align: center;
            font-size: 1.125rem;
            font-weight: 300;
        }

        .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1.25rem;
            cursor: pointer;
            transition: background 0.2s;
            line-height: 1;
            z-index: 10;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

    </style>
</head>
<body>

    <!-- Main Gallery Container (Horizontally Scrollable) -->
    <div id="galleryContainer" class="gallery-container">
        <div id="galleryCanvas" class="gallery-canvas">
            <!-- Image frames will be dynamically inserted here by JavaScript -->
        </div>
    </div>

    <!-- Edit/View Modal Popup -->
    <div id="artModal" class="modal-overlay hidden opacity-0 transition-opacity" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="closeModal()">âœ•</button>
            
            <div class="modal-image-container">
                <img id="modalImage" class="modal-image" src="" alt="Full size painting">
            </div>

            <div class="modal-controls bg-gray-800 p-4 rounded-lg">
                <input type="hidden" id="currentArtId">
                <p id="modalCaption" class="text-lg font-medium mb-4 text-center text-gray-200"></p>

                <div class="space-y-3">
                    <!-- Image Upload Control -->
                    <div>
                        <label for="imageUpload" class="block text-sm font-medium text-gray-400 mb-1">Upload New Image (.jpg, .png)</label>
                        <input type="file" id="imageUpload" accept="image/png, image/jpeg" 
                               class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600 transition duration-150">
                        <p class="text-xs text-gray-500 mt-1">Note: Complex cropping/adjustment features are not supported in this environment.</p>
                    </div>

                    <!-- Caption Edit Control -->
                    <div>
                        <label for="captionInput" class="block text-sm font-medium text-gray-400 mb-1">Edit Caption</label>
                        <input type="text" id="captionInput" placeholder="Enter your artwork caption"
                               class="w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Save Button -->
                    <button id="saveButton" onclick="saveArtwork()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-lg">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let userId = 'anonymous';

        let artworks = [];
        let isAuthReady = false;

        // --- Firebase Initialization and Auth ---
        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up auth listener and ensure sign-in
                const authPromise = new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Authenticated with userId:", userId);
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                        }
                        isAuthReady = true;
                        unsubscribe(); 
                        resolve();
                    });
                });
                
                await authPromise;

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
            }
        };

        // --- Gallery Data Setup and Merge Logic ---

        // Generate 100 placeholder image data objects
        const generatePlaceholders = () => {
            return Array.from({ length: 100 }, (_, i) => {
                const span = Math.floor(Math.random() * 3) + 1; // 1, 2, or 3
                const imageId = (i + 1).toString().padStart(3, '0');
                const placeholderSize = span * 150; 
                const placeholderColor = Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0');
                
                return {
                    id: String(i + 1), // Use string ID
                    caption: `Painting #${imageId}: Abstract Study in Color`,
                    imgUrl: `https://placehold.co/${placeholderSize}x${placeholderSize}/${placeholderColor}/FFFFFF?text=Art+${imageId}`,
                    span: span,
                    colSpanClass: `col-span-${span}`,
                    rowSpanClass: `row-span-${span}`,
                    isCustom: false
                };
            });
        };

        const placeholderArtworks = generatePlaceholders();

        const mergeArtworkData = (customData) => {
            const customMap = new Map(customData.map(item => [item.id, item]));
            
            artworks = placeholderArtworks.map(placeholder => {
                const custom = customMap.get(placeholder.id);
                if (custom) {
                    // Merge custom data (url and caption) into the placeholder
                    return {
                        ...placeholder,
                        imgUrl: custom.customImgUrl || placeholder.imgUrl,
                        caption: custom.customCaption || placeholder.caption,
                        isCustom: true
                    };
                }
                return placeholder;
            });
            renderGallery();
        };


        // --- Firestore Listener ---

        const setupFirestoreListener = () => {
            if (!isAuthReady || !db || !userId) return;

            const artCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/customArtworks`);
            const q = query(artCollectionRef);
            
            onSnapshot(q, (snapshot) => {
                const customData = snapshot.docs.map(doc => doc.data());
                mergeArtworkData(customData);
                console.log(`Loaded ${customData.length} custom artworks from Firestore.`);
            }, (error) => {
                console.error("Error setting up Firestore snapshot:", error);
            });
        };


        // --- Gallery DOM Manipulation ---

        const galleryCanvas = document.getElementById('galleryCanvas');
        const artModal = document.getElementById('artModal');
        const modalImage = document.getElementById('modalImage');
        const modalCaption = document.getElementById('modalCaption');
        const imageUpload = document.getElementById('imageUpload');
        const captionInput = document.getElementById('captionInput');
        const currentArtId = document.getElementById('currentArtId');


        // Function to open the modal
        window.openModal = (art) => {
            // Populate modal elements
            modalImage.src = art.imgUrl;
            modalImage.alt = art.caption;
            modalCaption.textContent = art.caption;
            captionInput.value = art.caption;
            currentArtId.value = art.id;
            imageUpload.value = null; // Clear file input

            artModal.classList.remove('hidden');
            setTimeout(() => artModal.classList.remove('opacity-0'), 10);
        };

        // Function to close the modal
        window.closeModal = () => {
            artModal.classList.add('opacity-0');
            setTimeout(() => {
                artModal.classList.add('hidden');
            }, 300); // Match transition duration
        };

        // Function to render all the artwork frames
        const renderGallery = () => {
            galleryCanvas.innerHTML = ''; // Clear existing frames
            artworks.forEach(art => {
                const frame = document.createElement('div');
                frame.className = `frame ${art.colSpanClass} ${art.rowSpanClass} ${art.isCustom ? 'ring-2 ring-indigo-500' : ''}`;
                frame.setAttribute('data-id', art.id);

                const img = document.createElement('img');
                img.src = art.imgUrl;
                img.alt = art.caption;
                img.loading = 'lazy';
                img.setAttribute('onerror', `this.onerror=null; this.src='https://placehold.co/300x300/333/FFF?text=Error'`);

                const captionOverlay = document.createElement('div');
                captionOverlay.className = 'caption-overlay';
                captionOverlay.textContent = art.caption.split(': ').length > 1 ? art.caption.split(': ')[1] : art.caption;

                // Click handler for opening the modal
                frame.addEventListener('click', () => {
                    openModal(art);
                });

                frame.appendChild(img);
                frame.appendChild(captionOverlay);
                galleryCanvas.appendChild(frame);
            });
        };

        // --- Image Handling and Saving ---

        imageUpload.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    // Temporarily display the uploaded image in the modal
                    modalImage.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
        });

        window.saveArtwork = async () => {
            if (!isAuthReady || !db || !userId) {
                console.error("Firebase not initialized or user not authenticated.");
                return;
            }

            const artId = currentArtId.value;
            const newCaption = captionInput.value;
            let newImgUrl = modalImage.src; 

            // Check if a new file was selected and convert it to Base64 if it's not already
            if (imageUpload.files && imageUpload.files[0]) {
                 // The imageUpload change listener has already set modalImage.src to the Base64 string
                 newImgUrl = modalImage.src;
            } else {
                // If no new file, but the image is a placeholder, check if we should keep it or if it's a custom one
                if (newImgUrl.startsWith('https://placehold.co')) {
                    // Do not save the placeholder URL to Firestore unless necessary.
                    newImgUrl = null;
                }
            }
            
            const artRef = doc(db, `artifacts/${appId}/users/${userId}/customArtworks`, artId);
            
            try {
                const dataToSave = {
                    id: artId,
                    customCaption: newCaption,
                    customImgUrl: newImgUrl,
                    timestamp: new Date().toISOString()
                };

                await setDoc(artRef, dataToSave, { merge: true });
                closeModal();

            } catch (error) {
                console.error("Error saving artwork to Firestore:", error);
            }
        };


        // --- Initialization ---

        window.onload = async () => {
            await initializeFirebase();
            // Start listening for custom art data only after authentication is complete
            setupFirestoreListener(); 
        };

    </script>
</body>
</html>